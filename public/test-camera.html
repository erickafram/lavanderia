<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de C√¢mera - Sistema Lavanderia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-result {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste de C√¢mera - Sistema Lavanderia</h1>
        <p>Esta p√°gina testa se a c√¢mera funciona corretamente para o scanner de QR Code.</p>
        
        <div class="test-section">
            <h2>üìã Diagn√≥stico Autom√°tico</h2>
            <div id="diagnostico"></div>
            <button onclick="executarDiagnostico()">üîç Executar Diagn√≥stico</button>
        </div>
        
        <div class="test-section">
            <h2>üì∑ Teste de C√¢mera</h2>
            <video id="video" autoplay playsinline></video>
            <br>
            <button onclick="iniciarCamera()">üì∑ Iniciar C√¢mera</button>
            <button onclick="pararCamera()">‚èπÔ∏è Parar C√¢mera</button>
            <div id="camera-status"></div>
        </div>
        
        <div class="test-section">
            <h2>üì± Informa√ß√µes do Sistema</h2>
            <div id="system-info"></div>
        </div>
        
        <div class="test-section">
            <h2>üîß Solu√ß√µes R√°pidas</h2>
            <div id="solucoes-rapidas"></div>
        </div>

        <div class="test-section">
            <h2>üîó Links √öteis</h2>
            <p>
                <a href="motorista/dashboard" target="_blank">üöö Dashboard do Motorista</a><br>
                <a href="../CAMERA_TROUBLESHOOTING.md" target="_blank">üìñ Guia de Solu√ß√£o de Problemas</a><br>
                <a href="https://localhost/lavanderia/public/motorista/dashboard" target="_blank">üîí Acesso HTTPS (se configurado)</a>
            </p>
        </div>
    </div>

    <script>
        let stream = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            return div;
        }
        
        function executarDiagnostico() {
            const diagnosticoDiv = document.getElementById('diagnostico');
            const solucoesDiv = document.getElementById('solucoes-rapidas');
            diagnosticoDiv.innerHTML = '';
            solucoesDiv.innerHTML = '';

            let problemas = [];
            let solucoes = [];

            // Verificar protocolo
            const isSecure = location.protocol === 'https:' ||
                           location.hostname === 'localhost' ||
                           location.hostname === '127.0.0.1';

            diagnosticoDiv.appendChild(log(
                `üîí Protocolo: ${location.protocol} ${isSecure ? '‚úÖ' : '‚ùå Necess√°rio HTTPS ou localhost'}`,
                isSecure ? 'success' : 'error'
            ));

            if (!isSecure) {
                problemas.push('protocolo');
                solucoes.push(`
                    <div class="status error">
                        <strong>‚ùå Problema: Protocolo n√£o seguro</strong><br>
                        <strong>Solu√ß√£o:</strong> Acesse via <a href="http://localhost/lavanderia/public/test-camera.html" target="_blank">http://localhost/lavanderia/public/test-camera.html</a><br>
                        <strong>Ou configure HTTPS:</strong> Execute o arquivo <code>setup-https-wamp.bat</code> como administrador
                    </div>
                `);
            }

            // Verificar host
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            diagnosticoDiv.appendChild(log(
                `üåê Host: ${location.hostname} ${isLocalhost || location.protocol === 'https:' ? '‚úÖ' : '‚ùå'}`,
                isLocalhost || location.protocol === 'https:' ? 'success' : 'error'
            ));

            if (!isLocalhost && location.protocol !== 'https:') {
                problemas.push('host');
                if (!solucoes.some(s => s.includes('localhost'))) {
                    solucoes.push(`
                        <div class="status error">
                            <strong>‚ùå Problema: Host n√£o √© localhost nem HTTPS</strong><br>
                            <strong>Solu√ß√£o:</strong> Acesse via <a href="http://localhost/lavanderia/public/test-camera.html" target="_blank">localhost</a>
                        </div>
                    `);
                }
            }

            // Verificar getUserMedia
            const hasGetUserMedia = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            diagnosticoDiv.appendChild(log(
                `üìπ getUserMedia: ${hasGetUserMedia ? '‚úÖ Suportado' : '‚ùå N√£o suportado'}`,
                hasGetUserMedia ? 'success' : 'error'
            ));
            
            // Verificar navegador
            const userAgent = navigator.userAgent;
            let browser = 'Desconhecido';
            let browserStatus = 'warning';
            
            if (userAgent.includes('Chrome')) {
                browser = 'Chrome ‚úÖ';
                browserStatus = 'success';
            } else if (userAgent.includes('Firefox')) {
                browser = 'Firefox ‚úÖ';
                browserStatus = 'success';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                browser = 'Safari ‚ö†Ô∏è';
                browserStatus = 'warning';
            } else if (userAgent.includes('Edge')) {
                browser = 'Edge ‚úÖ';
                browserStatus = 'success';
            }
            
            diagnosticoDiv.appendChild(log(`üåê Navegador: ${browser}`, browserStatus));
            
            // Verificar dispositivo
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            diagnosticoDiv.appendChild(log(
                `üì± Dispositivo: ${isMobile ? 'Mobile' : 'Desktop'}`,
                'info'
            ));
            
            // Verificar permiss√µes
            if (navigator.permissions) {
                navigator.permissions.query({name: 'camera'}).then(result => {
                    const status = result.state === 'granted' ? 'success' :
                                 result.state === 'denied' ? 'error' : 'warning';
                    const text = result.state === 'granted' ? '‚úÖ Permitida' :
                               result.state === 'denied' ? '‚ùå Negada' : '‚ö†Ô∏è N√£o definida';

                    diagnosticoDiv.appendChild(log(`üîê Permiss√£o: ${text}`, status));

                    if (result.state === 'denied') {
                        solucoes.push(`
                            <div class="status error">
                                <strong>‚ùå Problema: Permiss√£o de c√¢mera negada</strong><br>
                                <strong>Solu√ß√£o:</strong><br>
                                1. Clique no √≠cone de c√¢mera üì∑ na barra de endere√ßos<br>
                                2. Selecione "Permitir" para c√¢mera<br>
                                3. Recarregue a p√°gina (F5)
                            </div>
                        `);
                    }

                    // Mostrar solu√ß√µes
                    if (solucoes.length > 0) {
                        solucoesDiv.innerHTML = solucoes.join('');
                    } else {
                        solucoesDiv.innerHTML = '<div class="status success"><strong>‚úÖ Tudo configurado corretamente!</strong><br>A c√¢mera deve funcionar normalmente.</div>';
                    }
                }).catch(() => {
                    diagnosticoDiv.appendChild(log('üîê Permiss√£o: ‚ùì N√£o verific√°vel', 'warning'));
                    if (solucoes.length > 0) {
                        solucoesDiv.innerHTML = solucoes.join('');
                    }
                });
            } else {
                if (solucoes.length > 0) {
                    solucoesDiv.innerHTML = solucoes.join('');
                }
            }
            
            // Verificar c√¢meras dispon√≠veis
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices().then(devices => {
                    const cameras = devices.filter(device => device.kind === 'videoinput');
                    const status = cameras.length > 0 ? 'success' : 'error';
                    diagnosticoDiv.appendChild(log(
                        `üì∑ C√¢meras: ${cameras.length} encontrada(s) ${cameras.length > 0 ? '‚úÖ' : '‚ùå'}`,
                        status
                    ));
                }).catch(() => {
                    diagnosticoDiv.appendChild(log('üì∑ C√¢meras: ‚ùå Erro ao verificar', 'error'));
                });
            }
        }
        
        async function iniciarCamera() {
            const statusDiv = document.getElementById('camera-status');
            const video = document.getElementById('video');
            
            try {
                statusDiv.innerHTML = '';
                statusDiv.appendChild(log('üîÑ Iniciando c√¢mera...', 'info'));
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                video.srcObject = stream;
                statusDiv.appendChild(log('‚úÖ C√¢mera iniciada com sucesso!', 'success'));
                
            } catch (error) {
                console.error('Erro ao iniciar c√¢mera:', error);
                let mensagem = '‚ùå Erro: ';
                
                if (error.name === 'NotAllowedError') {
                    mensagem += 'Permiss√£o negada';
                } else if (error.name === 'NotFoundError') {
                    mensagem += 'C√¢mera n√£o encontrada';
                } else if (error.name === 'NotSupportedError') {
                    mensagem += 'C√¢mera n√£o suportada';
                } else {
                    mensagem += error.message;
                }
                
                statusDiv.appendChild(log(mensagem, 'error'));
            }
        }
        
        function pararCamera() {
            const statusDiv = document.getElementById('camera-status');
            const video = document.getElementById('video');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                statusDiv.appendChild(log('‚èπÔ∏è C√¢mera parada', 'info'));
            }
        }
        
        function mostrarInfoSistema() {
            const infoDiv = document.getElementById('system-info');
            
            const info = [
                `URL: ${location.href}`,
                `Protocolo: ${location.protocol}`,
                `Host: ${location.hostname}`,
                `Navegador: ${navigator.userAgent}`,
                `Idioma: ${navigator.language}`,
                `Plataforma: ${navigator.platform}`,
                `Cookies habilitados: ${navigator.cookieEnabled ? 'Sim' : 'N√£o'}`,
                `Online: ${navigator.onLine ? 'Sim' : 'N√£o'}`
            ];
            
            infoDiv.innerHTML = info.map(item => `<div class="test-result">${item}</div>`).join('');
        }
        
        // Executar diagn√≥stico e mostrar info do sistema ao carregar
        window.addEventListener('load', function() {
            executarDiagnostico();
            mostrarInfoSistema();
        });
    </script>
</body>
</html>
